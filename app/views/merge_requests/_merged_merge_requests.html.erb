<% merge_requests = merge_requests_dto.items %>
<% avg_time_to_merge =
  (
    if merge_requests.count.positive?
      ActiveSupport::Duration.build(
        merge_requests.sum { |mr| Time.current - mr.createdAt } /
          merge_requests.count,
      )
    else
      0
    end
  ) %>
<% overall_avg_time_to_merge =
  if merged_merge_requests_tttm
    ActiveSupport::Duration.build(
      merged_merge_requests_tttm / merged_merge_requests_count,
    )
  else
    ActiveSupport::Duration.years(1000)
  end %>
<% since_first_mr =
  ActiveSupport::Duration.build(
    Time.current - first_merged_merge_requests_timestamp,
  ) %>
<% monthly_merge_rate =
  (merged_merge_requests_count.to_f / since_first_mr.in_months.to_f).round %>

<div class="d-flex justify-content-between align-items-end">
  <div>
    <div class="lead">
      <% merge_rate_ok = merge_requests.count / 1.week.in_days * 30 >= monthly_merge_rate %>
      <%= tag.span(
        "#{pluralize(merge_requests.count, "merge request")} #{merge_rate_ok ? "↗" : "↘"}",
        class: merge_rate_ok ? "text-success" : "text-warning",
      ) %>
      merged in the last week
    </div>

    <% if merge_requests.count.positive? %>
      <% merge_time_ok = avg_time_to_merge <= overall_avg_time_to_merge %>
      <div>Merged on average after
        <%= tag.span(
          "#{distance_of_time_in_words(avg_time_to_merge)} #{merge_time_ok ? "↘" : "↗"}",
          class: merge_time_ok ? "text-success" : "text-warning",
        ) %>
      </div>
    <% end %>
  </div>

  <% if merged_merge_requests_count.positive? %>
    <div class="flex-row-reverse">
      <div>
        A total of
        <%= pluralize(merged_merge_requests_count, "merge request") %>
        merged since
        <%= local_relative_time(first_merged_merge_requests_timestamp, type: "time-or-date") %>,
        <% if monthly_merge_rate < 1.0 %>
          <%= (since_first_mr.in_months.to_f / merged_merge_requests_count.to_f).round(1) %>
          months per MR
        <% else %>
          <%= monthly_merge_rate.round %>
          per month
        <% end %>
      </div>
      <% if merged_merge_requests_tttm %>
        <div class="text-end">
          <div>Merged on average after
            <%= distance_of_time_in_words(overall_avg_time_to_merge) %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<% if merge_requests.any? %>
  <table class="table table-hover mb-0">
    <thead>
      <tr>
        <th scope="col">ID</th>
        <th scope="col">Merged&nbsp;↓</th>
        <th scope="col">Merged After</th>
        <th scope="col">Updated</th>
        <th scope="col">Workflow Labels</th>
        <th scope="col">Title</th>
        <th scope="col">
          Associated Issue
          <%= tag.i(
            class: %w[fa-solid fa-circle-info],
            data: {
              bs_toggle: "tooltip",
              bs_title: "Issue number is extracted from branch name, if present",
            },
          ) %>
        </th>
      </tr>
    </thead>

    <tbody>
      <% merge_requests.each do |mr| %>
        <%= tag.tr style: "cursor: pointer;" do %>
          <!-- MR ID -->
          <th scope="row">
            <%= render "mr_relation", merge_request: mr %>
          </th>
          <!-- Merged at -->
          <td>
            <%= render "shared/relative_timestamp",
            timestamp: mr.mergedAt,
            most_significant_only: true %>
            by
            <br/>
            <%= render "user_badge",
            user: mr.mergeUser,
            title: user_help_title(mr.mergeUser),
            class_suffix: "approved" %>
          </td>
          <!-- Merged After -->
          <td>
            <%= tag.span(
              distance_of_time_in_words(mr.mergedAt - mr.createdAt),
              class:
                ("text-danger" if mr.mergedAt - mr.createdAt > overall_avg_time_to_merge),
              data: {
                bs_toggle: "tooltip",
                bs_custom_class: "wide-tooltip",
                bs_title: "#{mr.createdAt.utc.to_formatted_s(:long)} UTC",
              },
            ) %>
          </td>
          <!-- Updated at -->
          <td>
            <%= render "shared/relative_timestamp",
            timestamp: mr.updatedAt,
            most_significant_only: true %>
          </td>
          <!-- Workflow Labels -->
          <td>
            <%= render partial: "gitlab_label",
            spacer_template: "space",
            collection: mr.contextualLabels,
            as: :label %>
          </td>
          <!-- Title -->
          <td>
            <%= render partial: "user_avatar", collection: mr.assignees.nodes, as: :user %>
            <%= link_to mr.titleHtml, mr.webUrl, target: "_blank" %>

            <div style="max-width: 26em">
              <%= render "branch_relation",
              source_branch: mr.sourceBranch,
              target_branch: mr.targetBranch %>
            </div>
          </td>
          <!-- Associated Issue -->
          <td>
            <%= render("issue_link", issue: mr.issue) if mr.issue %>
          </td>
        <% end %>
      <% end %>
    </tbody>
  </table>
<% end %>

<%= tag.div style: "height: 300px", class: %w[d-flex mt-2 align-items-center justify-content-sm-center],
  data: (load_charts ? {
    controller: "merged-merge-requests-chart",
    merged_merge_requests_chart_url_value: monthly_merged_merge_request_stats_url(assignee: params[:assignee])
  } : nil) do %>
  <%= tag.div(
    "Loading…",
    class: %w[d-flex align-items-center justify-content-center w-75 h-100],
    data: {
      merged_merge_requests_chart_target: "chart",
      theme_selector_target: "chart",
    },
    style:
      "color: #999; font-size: 14px; font-family: 'Lucida Grande', 'Lucida Sans Unicode', Verdana, Arial, Helvetica, sans-serif;",
  ) %>
<% end %>
