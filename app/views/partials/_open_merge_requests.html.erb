<table class="table table-hover table-sm" style="cursor: pointer;">
  <% any_conflicts = merge_requests.any?(&:conflicts) %>

  <caption><%= pluralize(merge_requests.count, "open merge request") %>, updated
    <%= render "partials/relative_timestamp", timestamp: @updated_at %>
  </caption>

  <thead>
    <tr>
      <th scope="col">ID</th>
      <th scope="col">Created</th>
      <th scope="col">Updated</th>
      <th scope="col">Status</th>
      <th scope="col"><i class="fa-solid fa-timeline"></i></th>
      <th scope="col">Title</th>
      <th scope="col"><%= tag.i(
          class: %w[fa-solid fa-angles-down],
          data: {
            bs_toggle: "tooltip",
            bs_title: "Squash?",
          },
        ) %>
      </th>
      <% if any_conflicts %>
        <th scope="col">Conflicts?</th>
      <% end %>
      <th scope="col"><%= tag.i class: %w[fa-regular fa-thumbs-up], title: "Approvals" %></th>
      <th scope="col"><%= tag.i class: %w[fa-solid fa-magnifying-glass] %>
        Reviewers</th>
      <th scope="col">Associated Issue</th>
    </tr>
  </thead>

  <tbody>
    <% merge_requests.each do |mr| %>
      <tr class="table-<%= mr.bootstrapClass[:row] %>">
        <!-- MR ID -->
        <th scope="row">
          <%= render "partials/link", title: mr.reference, web_url: mr.webUrl %>
        </th>
        <!-- Created at -->
        <td>
          <%= render "partials/relative_timestamp",
          timestamp: mr.createdAt,
          age_warning: true,
          most_significant_only: true %>
        </td>
        <!-- Updated at -->
        <td>
          <%= render "partials/relative_timestamp",
          timestamp: mr.updatedAt,
          most_significant_only: true %>
        </td>
        <!-- Merge status -->
        <td>
          <span class="badge bg-<%= mr.bootstrapClass[:mergeStatus] %>"><%= mr.detailedMergeStatus %></span>
          <% if mr.blockingMergeRequests&.visibleMergeRequests %>
            <% open_blockers =
              mr
                .blockingMergeRequests
                .visibleMergeRequests
                .filter { |blocker| blocker.state == "opened" }
                .count %>

            <% if open_blockers.positive? %>
              <%= render "partials/icon_with_title",
              content: tag.i(class: %w[fa-solid fa-road-barrier]),
              class: "text-danger",
              title: "This MR is blocked by #{pluralize(open_blockers, "merge request")}" %>
            <% end %>
          <% end %>
        </td>
        <!-- Pipeline -->
        <td>
          <nobr>
            <% if mr.headPipeline %>
              <%= tag.span(class: ["badge", "badge-pill", "bg-#{mr.bootstrapClass[:pipeline]}"]) do %>
                <%= link_to humanized_enum(mr.headPipeline&.status) || "??",
                mr.headPipeline&.webUrl,
                class: "text-light",
                target: "_blank" %>
              <% end %>
              <% if mr.headPipeline.failedJobs.count.to_i.positive? && mr.headPipeline.status != 'SUCCESS' %>
                <%= render "partials/icon_with_title",
                content: tag.i(class: %w[fa-solid fa-triangle-exclamation]),
                title:
                  "#{pluralize(mr.headPipeline.failedJobs.count.to_i, "job")} have failed in the pipeline",
                class: "text-warning" %>
              <% end %>
              <% if mr.headPipeline.failureReason %>
                <%= render "partials/icon_with_title",
                content: tag.i(class: %w[fa-solid fa-comment-dots]),
                class: "text-warning",
                title: mr.headPipeline.failureReason %>
              <% end %>
              <% if mr.headPipeline.startedAt %>
                <% if mr.headPipeline.finishedAt.nil? %>
                  <%= render "partials/relative_timestamp", timestamp: mr.headPipeline.startedAt %>
                <% elsif mr.headPipeline.finishedAt < 8.hours.ago %>
                  <%= render "partials/icon_with_title",
                  content: "ðŸ¥¶",
                  title: "Pipeline too old, must be re-run before being merged" %>
                <% end %>
              <% end %>
            <% end %>

            <% if mr.autoMergeEnabled %>
              <%= render "partials/icon_with_title", content: "ðŸš€", title: "Auto-merge is enabled" %>
            <% end %>
          </nobr>

          <br/>

          <%= render partial: "partials/label", collection: mr.labels.nodes %>
        </td>
        <!-- Title -->
        <td>
          <%= render partial: "partials/user_avatar",
          collection: mr.assignees.nodes,
          as: :user %>

          <%= link_to mr.titleHtml, mr.webUrl, target: "_blank" %>

          <br/>

          <%= render "partials/branch_ref",
          source_branch: mr.sourceBranch,
          target_branch: mr.targetBranch %>
        </td>
        <!-- Squash on merge -->
        <td class="text-center">
          <% if mr.squashOnMerge %>
            <%= render "partials/icon_with_title",
            content: tag.i(class: %w[fa-solid fa-angles-down]),
            title: "MR set to squash on merge",
            class: "text-success" %>
          <% end %>
        </td>
        <!-- Conflicts -->
        <% if any_conflicts %>
          <td class="text-center">
            <% if mr.conflicts %>
              <%= render "partials/icon_with_title",
              content: tag.i(class: %w[fa-solid fa-burst]),
              class: "text-danger",
              title: "MR branch has conflicts and should be rebased" %>
            <% end %>
          </td>
        <% end %>
        <!-- Approvals -->
        <td class="text-end">
          <% if mr.approved %>
            <%= render "partials/icon_with_title",
            content: tag.i(class: %w[fa-regular fa-thumbs-up]),
            class: "text-success",
            title: "Approved" %>
          <% else %>
            <%= tag.progress(
              value: mr.approvalsRequired - mr.approvalsLeft,
              max: mr.approvalsRequired,
              style: "width: 20px",
              data: {
                bs_toggle: "tooltip",
                bs_title: "#{pluralize(mr.approvalsLeft, "approval")} missing",
              },
            ) %>
          <% end %>
        </td>
        <!-- Reviewers -->
        <td>
          <%= render(
            partial: "partials/reviewer_badge",
            spacer_template: "partials/space",
            collection: mr.reviewers.nodes,
            as: :reviewer,
          ) || "Not assigned" %>
        </td>
        <!-- Associated Issue -->
        <td scope="row">
          <% if mr.issue %>
            <%= render "partials/link",
            title: "\##{mr.issue.iid}",
            web_url: mr.issue.webUrl,
            kwattrs: {
              data: {
                bs_toggle: "tooltip",
                bs_html: "true",
                bs_custom_class: "x-wide-tooltip",
                bs_title: mr.issue.titleHtml,
              },
            } %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
